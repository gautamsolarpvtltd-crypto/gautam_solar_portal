{% extends "base.html" %}
{% block title %}Certificate Portal{% endblock %}

{% block extra_css %}
<style>
    .portal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .product-card {
        transition: transform 0.2s;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .doc-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        background: #f8f9fa;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .doc-badge:hover {
        background: #e9ecef;
        transform: scale(1.05);
    }
    .category-section {
        margin-bottom: 3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="portal-header">
    <div class="container text-center">
        <h1><i class="fas fa-certificate"></i> Certificate Portal</h1>
        <p class="lead">Access all product certificates and documents</p>
        {% if is_logged_in %}
        <p>Welcome, <strong>{{ user_name }}</strong>!</p>
        {% else %}
        <a href="/login" class="btn btn-light btn-lg mt-3">
            <i class="fas fa-sign-in-alt"></i> Login to Download
        </a>
        {% endif %}
    </div>
</div>

<div class="container">
    <div id="portalContent">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading certificates...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/portal-data');
        const data = await response.json();
        
        let html = '';
        
        // Company Documents
        if (data.companyDocs && Object.keys(data.companyDocs).length > 0) {
            html += '<div class="card mb-4"><div class="card-body">';
            html += '<h3 class="mb-4"><i class="fas fa-building"></i> Company Documents</h3>';
            
            for (const [location, docs] of Object.entries(data.companyDocs)) {
                html += `<h5 class="text-primary">${location}</h5>`;
                html += '<div class="mb-3">';
                docs.forEach(doc => {
                    html += `<a href="${doc.link}" class="doc-badge">
                        <i class="fas fa-file-pdf text-danger"></i> ${doc.name}
                    </a>`;
                });
                html += '</div>';
            }
            html += '</div></div>';
        }
        
        // Product Categories
        data.categories.forEach(category => {
            html += '<div class="category-section">';
            html += `<h2 class="mb-4"><i class="fas fa-solar-panel"></i> ${category.name}</h2>`;
            if (category.description) {
                html += `<p class="text-muted">${category.description}</p>`;
            }
            
            html += '<div class="row g-4">';
            category.products.forEach(product => {
                html += '<div class="col-md-6 col-lg-4">';
                html += '<div class="card product-card h-100">';
                html += '<div class="card-body">';
                html += `<h5 class="card-title">${product.wattage}</h5>`;
                
                if (product.documents && product.documents.length > 0) {
                    product.documents.forEach(doc => {
                        if (data.isLoggedIn) {
                            html += `<div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="documents" value="${doc.id}" id="doc${doc.id}">
                                <label class="form-check-label" for="doc${doc.id}">
                                    ${doc.name}
                                </label>
                            </div>`;
                        } else {
                            html += `<div class="mb-2">
                                <i class="fas fa-lock text-warning"></i> ${doc.name}
                            </div>`;
                        }
                    });
                } else {
                    html += '<p class="text-muted">No documents available</p>';
                }
                
                html += '</div></div></div>';
            });
            html += '</div></div>';
        });
        
        if (data.isLoggedIn && data.categories.length > 0) {
            html += `<div class="text-center mt-5">
                <form method="POST" action="/download/certificates">
                    <div id="selectedDocs"></div>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-download"></i> Download Selected Certificates
                    </button>
                </form>
            </div>`;
        }
        
        document.getElementById('portalContent').innerHTML = html;
        
        // Add event listeners for checkboxes
        if (data.isLoggedIn) {
            document.querySelectorAll('input[name="documents"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedDocs);
            });
        }
        
    } catch (error) {
        console.error('Error loading portal data:', error);
        document.getElementById('portalContent').innerHTML = 
            '<div class="alert alert-danger">Error loading certificates. Please refresh the page.</div>';
    }
});

function updateSelectedDocs() {
    const form = document.querySelector('form[action="/download/certificates"]');
    const container = document.getElementById('selectedDocs');
    container.innerHTML = '';
    
    document.querySelectorAll('input[name="documents"]:checked').forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'documents[]';
        input.value = checkbox.value;
        container.appendChild(input);
    });
}
</script>
{% endblock %}